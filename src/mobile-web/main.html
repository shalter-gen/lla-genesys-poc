<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genesys Chat PWA</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Lifeline Chat">
    
    <!-- Inline PWA Manifest -->
    <!-- <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiR2VuZXN5cyBDaGF0IFBXQSIsInNob3J0X25hbWUiOiJHZW5lc3lzIENoYXQiLCJkZXNjcmlwdGlvbiI6IlByb2dyZXNzaXZlIFdlYiBBcHAgZm9yIEdlbmVzeXMgQ2hhdCB3aXRoIG5vdGlmaWNhdGlvbnMgc3VwcG9ydCIsInN0YXJ0X3VybCI6Ii8iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsIm9yaWVudGF0aW9uIjoicG9ydHJhaXQtcHJpbWFyeSIsInRoZW1lX2NvbG9yIjoiIzAwMDAwMCIsImJhY2tncm91bmRfY29sb3IiOiIjZmZmZmZmIiwic2NvcGUiOiIvIiwibGFuZyI6ImVuIiwiY2F0ZWdvcmllcyI6WyJidXNpbmVzcyIsImNvbW11bmljYXRpb24iXSwiaWNvbnMiOlt7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjNhV1IwYUQwaWFXTnZiaUlnYUdWcFoyaDBQU0pwWTI5dUlpQjJhV1YzUW05NFBTSTBJREF3SURFNU1pQXhPVElpSUhac2JXNXpQU0pvZEhSd09pOHZkM2QzTG5jekxtOXlaeTh5TURBd0wzTjJaeUkrUEhCaGRHZ2dabWxzYkQwaUl6QTNNRGN6WmlJZ1pEMGliVGsySURZMGF6RXlMamcwTFRFMElERXlMamcwTFRFMGNUQXROUzQyTkMweE1pNDROQzB4TkMweE1pNDROQzB4TkhvdE1UQXVNalF0TVRNdU5EWXRNakV1TmpndE1URXVPVEP0TFRndU1EUXRNek11TWpOaU1qUXVPRGd4T1M0eE1EQXhMamt5TXpneElHVTBMVFV1TURZeklESXlMakUxTURJdE1Ua3VPRGs0SURJME1UUXVOVEEwTFRBdU16a3pJRFEwTVM0ME1qZ3ROVE11T1Rnek1qRXVNell6TFRJMElHVXhNVzQyT1RRdE5UYzVMall3T1MwNWFXOWtJRVJwVUhKQ1Z6azJNREYwUkdocFFsTTBPVUl6WWpobVFrOXlaVzlQZEZGcE5WZzVZazgyZEVnNVl6VnlTRGhsZWtod0p5OCtQQzl3WVhSb1BqeDBaWGgwSUVacGJHdzlJaU14Wm1abVptWm1JaUIyWVd4cFoyNHRZbUZ6Wld4c -->
    <link rel="manifest" href="manifest.json">

    <!-- Icons -->
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .status.success { background: #d4edda; color: #155724; }
        .status.warning { background: #fff3cd; color: #856404; }
        .status.error { background: #f8d7da; color: #721c24; }
        
        .install-prompt {
            background: #007bff;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            display: none;
        }
        
        .install-prompt button {
            background: white;
            color: #007bff;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            margin-left: 10px;
            cursor: pointer;
        }
        
        .notification-alert {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #333;
            color: white;
            padding: 15px;
            border-radius: 5px;
            z-index: 9999;
            max-width: 300px;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        .controls {
            margin: 20px 0;
        }
        
        .controls button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            margin: 5px;
            cursor: pointer;
        }
        
        .controls button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Genesys Chat PWA</h1>
        
        <div id="status-container"></div>
        
        <div id="install-prompt" class="install-prompt">
            <strong>Enable Notifications:</strong> Add this app to your home screen to receive chat notifications.
            <button onclick="showInstallInstructions()">Show Instructions</button>
        </div>
        
        <div class="controls">
            <button id="enable-notifications" onclick="enableNotifications()">Enable Notifications</button>
            <button id="test-notification" onclick="testNotification()" disabled>Test Notification</button>
        </div>
        
        <div id="genesys-container">
            <h3>Genesys Chat Status</h3>
            <div id="genesys-status">Loading Genesys...</div>
        </div>
    </div>

    <script>
        // Global state
        let notificationsSubscribed = false;
        let serviceWorkerReady = false;
        let genesysReady = false;
        
        // Utility functions
        function isIOS() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent);
        }
        
        function isPWAInstalled() {
            return window.matchMedia('(display-mode: standalone)').matches || 
                   window.navigator.standalone === true;
        }
        
        function isAndroid() {
            return /Android/.test(navigator.userAgent);
        }
        
        function isChrome() {
            return /Chrome/.test(navigator.userAgent) && !/Edge/.test(navigator.userAgent);
        }
        
        function requiresServiceWorkerNotifications() {
            // Browsers that require service worker for notifications
            return isAndroid() && (
                /Chrome/.test(navigator.userAgent) ||
                /Samsung/.test(navigator.userAgent) ||
                /Edge/.test(navigator.userAgent) ||
                /Opera/.test(navigator.userAgent)
            );
        }
        
        function showStatus(message, type = 'info') {
            const container = document.getElementById('status-container');
            const status = document.createElement('div');
            status.className = `status ${type}`;
            status.textContent = message;
            container.appendChild(status);
            
            // Remove after 5 seconds
            setTimeout(() => status.remove(), 5000);
        }
        
        function showInPageAlert(message) {
            const alert = document.createElement('div');
            alert.className = 'notification-alert';
            alert.innerHTML = `<strong>New Message:</strong><br>${message}`;
            document.body.appendChild(alert);
            
            setTimeout(() => alert.remove(), 5000);
        }
        
        // Service Worker Registration
        async function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    // Create service worker code as a string
                    const swCode = `
                        // Inline Service Worker for Genesys Chat PWA
                        const CACHE_NAME = 'genesys-chat-pwa-v1';
                        const urlsToCache = ['/'];

                        // Install event
                        self.addEventListener('install', event => {
                            console.log('[SW] Install event');
                            event.waitUntil(
                                caches.open(CACHE_NAME)
                                    .then(cache => {
                                        console.log('[SW] Opened cache');
                                        return cache.addAll(urlsToCache);
                                    })
                                    .catch(error => {
                                        console.log('[SW] Cache failed:', error);
                                    })
                            );
                            self.skipWaiting();
                        });

                        // Activate event
                        self.addEventListener('activate', event => {
                            console.log('[SW] Activate event');
                            event.waitUntil(
                                caches.keys().then(cacheNames => {
                                    return Promise.all(
                                        cacheNames.map(cacheName => {
                                            if (cacheName !== CACHE_NAME) {
                                                console.log('[SW] Deleting old cache:', cacheName);
                                                return caches.delete(cacheName);
                                            }
                                        })
                                    );
                                })
                            );
                            self.clients.claim();
                        });

                        // Fetch event
                        self.addEventListener('fetch', event => {
                            if (event.request.method !== 'GET') return;
                            if (!event.request.url.startsWith(self.location.origin)) return;
                            
                            event.respondWith(
                                caches.match(event.request)
                                    .then(response => {
                                        return response || fetch(event.request);
                                    })
                                    .catch(error => {
                                        console.log('[SW] Fetch failed:', error);
                                    })
                            );
                        });

                        // Push event
                        self.addEventListener('push', event => {
                            console.log('[SW] Push received:', event);
                            
                            let notificationData = {
                                title: 'New Message',
                                body: 'You have a new message',
                                icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iaWNvbiIgaGVpZ2h0PSJpY29uIiB2aWV3Qm94PSIwIDAgMTkyIDE5MiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cGF0aCBmaWxsPSIjMDA3M2ZmIiBkPSJtOTYgNjRrMTIuODQtMTQgMTIuODQtMTRxMC01LjY0LTEyLjg0LTE0LTEyLjg0LTE0eiIvPgo8L3N2Zz4K',
                                badge: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iaWNvbiIgaGVpZ2h0PSJpY29uIiB2aWV3Qm94PSIwIDAgMTkyIDE5MiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cGF0aCBmaWxsPSIjMDA3M2ZmIiBkPSJtOTYgNjRrMTIuODQtMTQgMTIuODQtMTRxMC01LjY0LTEyLjg0LTE0LTEyLjg0LTE0eiIvPgo8L3N2Zz4K',
                                tag: 'genesys-message'
                            };
                            
                            if (event.data) {
                                try {
                                    const data = event.data.json();
                                    notificationData = { ...notificationData, ...data };
                                } catch (error) {
                                    console.log('[SW] Push data parse error:', error);
                                    notificationData.body = event.data.text() || notificationData.body;
                                }
                            }
                            
                            event.waitUntil(
                                self.registration.showNotification(notificationData.title, {
                                    body: notificationData.body,
                                    icon: notificationData.icon,
                                    badge: notificationData.badge,
                                    tag: notificationData.tag,
                                    requireInteraction: false,
                                    data: notificationData.data
                                })
                            );
                        });

                        // Notification click event
                        self.addEventListener('notificationclick', event => {
                            console.log('[SW] Notification clicked:', event.notification);
                            event.notification.close();
                            
                            event.waitUntil(
                                clients.matchAll({
                                    type: 'window',
                                    includeUncontrolled: true
                                }).then(clientList => {
                                    for (let client of clientList) {
                                        if (client.url.includes(self.location.origin) && 'focus' in client) {
                                            client.postMessage({
                                                type: 'NOTIFICATION_CLICKED',
                                                data: event.notification.data
                                            });
                                            return client.focus();
                                        }
                                    }
                                    
                                    if (clients.openWindow) {
                                        return clients.openWindow('/');
                                    }
                                })
                            );
                        });

                        // Message event
                        self.addEventListener('message', event => {
                            console.log('[SW] Message received:', event.data);
                            
                            if (event.data && event.data.type === 'SHOW_NOTIFICATION') {
                                const { title, body, icon, data } = event.data;
                                
                                self.registration.showNotification(title || 'New Message', {
                                    body: body || 'You have a new message',
                                    icon: icon || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iaWNvbiIgaGVpZ2h0PSJpY29uIiB2aWV3Qm94PSIwIDAgMTkyIDE5MiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cGF0aCBmaWxsPSIjMDA3M2ZmIiBkPSJtOTYgNjRrMTIuODQtMTQgMTIuODQtMTRxMC01LjY0LTEyLjg0LTE0LTEyLjg0LTE0eiIvPgo8L3N2Zz4K',
                                    badge: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iaWNvbiIgaGVpZ2h0PSJpY29uIiB2aWV3Qm94PSIwIDAgMTkyIDE5MiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cGF0aCBmaWxsPSIjMDA3M2ZmIiBkPSJtOTYgNjRrMTIuODQtMTQgMTIuODQtMTRxMC01LjY0LTEyLjg0LTE0LTEyLjg0LTE0eiIvPgo8L3N2Zz4K',
                                    tag: 'genesys-message',
                                    requireInteraction: false,
                                    data: data || {}
                                });
                            }
                        });

                        console.log('[SW] Inline Service Worker loaded');
                    `;

                    // Create blob from service worker code
                    const swBlob = new Blob([swCode], { type: 'application/javascript' });
                    const swUrl = URL.createObjectURL(swBlob);

                    // Register the service worker from blob URL
                    const registration = await navigator.serviceWorker.register(swUrl);
                    console.log('Service Worker registered:', registration);
                    serviceWorkerReady = true;
                    showStatus('Service Worker registered successfully', 'success');
                    
                    // Listen for messages from service worker
                    navigator.serviceWorker.addEventListener('message', event => {
                        if (event.data.type === 'NOTIFICATION_CLICKED') {
                            console.log('Notification clicked, focusing window');
                        }
                    });
                    
                    return registration;
                } catch (error) {
                    console.error('Service Worker registration failed:', error);
                    showStatus('Service Worker registration failed', 'error');
                    return null;
                }
            } else {
                showStatus('Service Workers not supported', 'error');
                return null;
            }
        }
        
        // Notification handling
        async function requestNotificationPermission() {
            if (!('Notification' in window)) {
                showStatus('Notifications not supported', 'error');
                return false;
            }
            
            // For iOS, check if PWA is installed
            if (isIOS() && !isPWAInstalled()) {
                document.getElementById('install-prompt').style.display = 'block';
                showStatus('iOS requires PWA installation for notifications', 'warning');
                return false;
            }
            
            let permission = Notification.permission;
            
            if (permission === 'default') {
                permission = await Notification.requestPermission();
            }
            
            if (permission === 'granted') {
                showStatus('Notification permission granted', 'success');
                document.getElementById('test-notification').disabled = false;
                return true;
            } else {
                showStatus('Notification permission denied', 'error');
                return false;
            }
        }
        
                        async function showNotification(title, body, data = {}) {
            if (!serviceWorkerReady) {
                showInPageAlert(body);
                return;
            }
            
            try {
                const registration = await navigator.serviceWorker.ready;
                
                // For iOS PWA and Android browsers that require service worker
                if ((isIOS() && isPWAInstalled()) || requiresServiceWorkerNotifications()) {
                    await registration.showNotification(title, {
                        body: body,
                        icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iaWNvbiIgaGVpZ2h0PSJpY29uIiB2aWV3Qm94PSIwIDAgMTkyIDE5MiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cGF0aCBmaWxsPSIjMDA3M2ZmIiBkPSJtOTYgNjRrMTIuODQtMTQgMTIuODQtMTRxMC01LjY0LTEyLjg0LTE0LTEyLjg0LTE0eiIvPgo8L3N2Zz4K',
                        badge: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iaWNvbiIgaGVpZ2h0PSJpY29uIiB2aWV3Qm94PSIwIDAgMTkyIDE5MiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cGF0aCBmaWxsPSIjMDA3M2ZmIiBkPSJtOTYgNjRrMTIuODQtMTQgMTIuODQtMTRxMC01LjY0LTEyLjg0LTE0LTEyLjg0LTE0eiIvPgo8L3N2Zz4K',
                        tag: 'genesys-message',
                        data: data,
                        requireInteraction: false,
                        silent: false
                    });
                } else if (Notification.permission === 'granted') {
                    // Fallback for Firefox Android and other browsers that support direct notifications
                    new Notification(title, {
                        body: body,
                        icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iaWNvbiIgaGVpZ2h0PSJpY29uIiB2aWV3Qm94PSIwIDAgMTkyIDE5MiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cGF0aCBmaWxsPSIjMDA3M2ZmIiBkPSJtOTYgNjRrMTIuODQtMTQgMTIuODQtMTRxMC01LjY0LTEyLjg0LTE0LTEyLjg0LTE0eiIvPgo8L3N2Zz4K',
                        data: data
                    });
                } else {
                    showInPageAlert(body);
                }
            } catch (error) {
                console.error('Notification failed:', error);
                showInPageAlert(body);
            }
        }
        
        // Genesys integration
        function onGenesysReady(callback) {
            if (typeof Genesys === "function") {
                if (!onGenesysReady._subscribed) {
                    onGenesysReady._subscribed = true;
                    Genesys("subscribe", "Messenger.ready", function() {
                        console.log("[Genesys] Messenger.ready event fired.");
                        genesysReady = true;
                        document.getElementById('genesys-status').textContent = 'Genesys Ready âœ“';
                        showStatus('Genesys Messenger ready', 'success');
                        callback();
                    });
                }
            } else {
                setTimeout(function() { onGenesysReady(callback); }, 250);
            }
        }
        
        function setupMessageNotifications() {
            if (notificationsSubscribed || !genesysReady) return;
            
            notificationsSubscribed = true;
            
            Genesys("subscribe", "MessagingService.messagesReceived", function(event) {
                console.log("[Genesys] Got event: ", JSON.stringify(event));
                
                if (!event || !event.data || !event.data.messages) return;
                
                event.data.messages.forEach(function(msg) {
                    if (msg.direction === "Outbound" && 
                        (msg.type === "Text" || msg.type === "Structured") && 
                        msg.text) {
                        
                        console.log("[Genesys] Notifying for received msg: ", msg.text);
                        
                        showNotification("New message received", msg.text, {
                            messageId: msg.id,
                            timestamp: new Date().toISOString()
                        });
                    }
                });
            });
            
            console.log("[Genesys] Subscribed to MessagingService.messagesReceived.");
            showStatus('Subscribed to Genesys notifications', 'success');
        }
        
        // UI handlers
        async function enableNotifications() {
            const granted = await requestNotificationPermission();
            if (granted && genesysReady) {
                setupMessageNotifications();
            }
        }
        
        async function testNotification() {
            await showNotification("Test Notification", "This is a test message to verify notifications are working!");
        }
        
        function showInstallInstructions() {
            if (isIOS()) {
                alert(`To enable notifications on iOS:
1. Open this page in Safari
2. Tap the Share button (square with arrow up)
3. Scroll down and tap "Add to Home Screen"
4. Tap "Add" in the top right corner
5. Open the app from your home screen
6. Enable notifications when prompted`);
            } else {
                alert(`To enable notifications:
1. Look for the "Install" or "Add to Home Screen" prompt
2. Click "Install" or "Add"
3. Open the installed app
4. Enable notifications when prompted`);
            }
        }
        
        // Initialize app
        async function initializeApp() {
            showStatus('Initializing PWA...', 'info');
            
            // Register service worker
            await registerServiceWorker();
            
            // Check PWA installation status
            if (isIOS() && !isPWAInstalled()) {
                document.getElementById('install-prompt').style.display = 'block';
            }
            
            // Initialize Genesys
            onGenesysReady(function() {
                if (Notification.permission === 'granted') {
                    setupMessageNotifications();
                    document.getElementById('test-notification').disabled = false;
                }
            });
            
            showStatus('PWA initialized', 'success');
        }
        
        // Start the app when DOM is loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
    </script>
    
    <!-- Genesys Integration -->
    <script>
        (function (g, e, n, es, ys) {
            g['_genesysJs'] = e;
            g[e] = g[e] || function () {
                (g[e].q = g[e].q || []).push(arguments)
            };
            g[e].t = 1 * new Date();
            g[e].c = es;
            ys = document.createElement('script'); 
            ys.async = 1; 
            ys.src = n; 
            ys.charset = 'utf-8'; 
            document.head.appendChild(ys);
        })(window, 'Genesys', 'https://apps.mypurecloud.com.au/genesys-bootstrap/genesys.min.js', {
            environment: 'prod-apse2',
            deploymentId: 'c1505209-b3f1-4092-8c61-41516695ba2e',
            debug: false
        });
    </script>
</body>
</html>